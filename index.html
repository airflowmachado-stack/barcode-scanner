<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<title>Plantilla de Servicio</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
  h2 { text-align: center; margin-bottom: 20px; }
  form { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  label { display: block; margin-top: 15px; font-weight: bold; }
  label span.required { color: red; margin-left: 5px; }
  input, select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
  button { margin-top: 20px; padding: 10px; width: 100%; border: none; background-color: #0088cc; color: white; font-size: 16px; border-radius: 5px; cursor: pointer; }
  button:hover { background-color: #006699; }
</style>
</head>
<body>
<h2>Plantilla de Servicio</h2>
<form id="surveyForm">
  <!-- MTS Bajante -->
  <label for="mts">MTS Bajante <span class="required">*</span></label>
  <select id="mts" name="mts" required>
    <option value="">Selecciona MTS</option>
    <option>25</option><option>50</option><option>75</option><option>100</option>
    <option>125</option><option>150</option><option>175</option><option>200</option>
    <option>225</option><option>250</option>
  </select>

  <!-- Técnico -->
  <label for="tecnico">Técnico <span class="required">*</span></label>
  <select id="tecnico" name="tecnico" required>
    <option value="">Selecciona Técnico</option>
    <option>Tecnico1</option><option>Tecnico2</option><option>Tecnico3</option>
    <option>Tecnico4</option><option>Tecnico5</option><option>Tecnico6</option>
    <option>Tecnico7</option><option>Tecnico8</option><option>Tecnico9</option>
  </select>

  <!-- Día de Servicio -->
  <label for="fecha">Día de Servicio <span class="required">*</span></label>
  <input type="date" id="fecha" name="fecha" required>

  <!-- Orden Liquidada -->
  <label for="orden">Orden Liquidada <span class="required">*</span></label>
  <select id="orden" name="orden" required>
    <option value="">Selecciona Orden</option>
    <option>Fibra</option>
    <option>Cobre</option>
    <option>Migración</option>
  </select>

  <!-- Tipo de Orden (dropdown) -->
  <div id="tipoOrdenField" style="margin-top:15px; display:block;">
    <label for="tipoDe">Tipo de Orden <span class="required">*</span></label>
    <select id="tipoDe" name="tipoDe" required>
      <option value="">Selecciona Tipo</option>
      <option>Aérea</option>
      <option>Subterránea</option>
    </select>
  </div>

  <!-- Tenativo -->
  <label for="tenativo">Tenativo <span class="required">*</span></label>
  <input type="text" id="tenativo" name="tenativo" placeholder="10 dígitos" required maxlength="10">

  <!-- OS -->
  <label for="os">OS <span class="required">*</span></label>
  <input type="text" id="os" name="os" placeholder="9 dígitos" required maxlength="9">

  <!-- Dirección -->
  <label for="direccion">Dirección <span class="required">*</span></label>
  <input type="text" id="direccion" name="direccion" required>

  <!-- Terminal -->
  <label for="terminal">Terminal <span class="required">*</span></label>
  <input type="text" id="terminal" name="terminal" required>

  <!-- Photo Domicilio -->
  <label for="photo">Foto del Domicilio <span class="required">*</span></label>
  <input type="file" id="photo" name="photo" accept="image/*" required>

  <button type="submit" style="margin-top:20px;">Enviar</button>
</form>
<script>
  
document.addEventListener("DOMContentLoaded", () => {
  const tg = window.Telegram?.WebApp;

  console.log("Telegram WebApp object:", tg);

  tg.ready(() => {
    console.log("Telegram WebApp object:", tg);
    alert("✅ WebApp fully loaded. User ID: " + tg.initDataUnsafe?.user?.id);
});

  // Optional quick debug with alert (useful if you don't have remote inspector)
  if(!tg) {
    alert("⚠️ Not running inside Telegram WebApp!");
  } else {
    alert("✅ Running inside Telegram WebApp. User ID: " + tg.initDataUnsafe?.user?.id);
  }
  const ordenSelect = document.getElementById("orden");
  const tipoOrdenField = document.getElementById("tipoOrdenField");
  const tipoDe = document.getElementById("tipoDe");

  // Show/hide Tipo de Orden only if Cobre is selected
  function updateTipoOrdenVisibility() {
    if (ordenSelect.value === "Cobre") {
      tipoOrdenField.style.display = "none";   // hide
      tipoDe.value = "";                        // clear selection
      tipoDe.required = false;
    } else {
      tipoOrdenField.style.display = "block";  // show for all other options including ""
      tipoDe.required = true;
    }
  }

  updateTipoOrdenVisibility();
  ordenSelect.addEventListener("change", updateTipoOrdenVisibility);

  // Digit-only enforcement
  function enforceDigitsStrict(input, maxLength) {
    input.addEventListener("keydown", (e) => {
      const allowedKeys = ["Backspace","Delete","ArrowLeft","ArrowRight","Tab"];
      if(allowedKeys.includes(e.key)) return;
      if(!/[0-9]/.test(e.key) || input.value.length >= maxLength) e.preventDefault();
    });
    input.addEventListener("paste", (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData("text");
      const digits = paste.replace(/\D/g,'').slice(0, maxLength - input.value.length);
      input.value += digits;
    });
  }

  enforceDigitsStrict(document.getElementById("tenativo"), 10);
  enforceDigitsStrict(document.getElementById("os"), 9);

  // Form submission
  document.getElementById("surveyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const requiredFields = document.querySelectorAll("#surveyForm [required]");
    for(let field of requiredFields) {
      if(!field.value) {
        alert("Por favor completa todos los campos obligatorios (*)");
        field.focus();
        return;
      }
    }
    const fileInput = document.querySelector('input[name="photo"]');
    let photoUrl = "";
    if(fileInput.files.length > 0) {
        // For now, just send the file name; in production, use GCS or your backend
        photoUrl = fileInput.files[0].name;
    }
    let modemNumber = "TEST_MODEM";
    const data = {
        fecha: document.querySelector('input[name="fecha"]').value,
        orden: ordenSelect.value,
        tipo: document.querySelector('select[name="tipoDe"]').value,
        mts: document.querySelector('select[name="mts"]').value,
        tecnico: document.querySelector('select[name="tecnico"]').value,
        tenativo: document.querySelector('input[name="tenativo"]').value,
        os: document.querySelector('input[name="os"]').value,
        direccion: document.querySelector('input[name="direccion"]').value,
        terminal: document.querySelector('input[name="terminal"]').value,
        ont: modemNumber,
        photo: photoUrl
    };
    data['submission_id'] = crypto.randomUUID();
    // Send to Telegram if available, else log to console
    console.log("tg object:", window.Telegram?.WebApp);
    console.log("JSON:", JSON.stringify(data));
    const response = await fetch("https://unseized-submuscularly-janeen.ngrok-free.dev/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
    });
    
    const result = await response.json();
    console.log("Response:",response.json())
    if (result.success) {
      alert("✅ Datos enviados correctamente.");
      tg.close();  // closes Mini App and returns to chat
    } else {
      alert("⚠️ Error al enviar datos. Verifique su internet");
    }

  });
});
</script>
</body>
</html>
